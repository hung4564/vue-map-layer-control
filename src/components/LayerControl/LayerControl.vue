<template>
  <ModuleContainer v-bind="bindModule">
    <template #btn>
      <MapControlButton
        v-if="!show"
        :tooltip="$map.trans('map.home.title')"
        @click="toggleShow()"
        :active="show"
      >
        <SvgIcon size="14" type="mdi" :path="path.icon" />
      </MapControlButton>
    </template>
    <template #draggable="props">
      <DraggableSidebar v-bind="props" :show.sync="show">
        <template #title>
          <span class="layer-control__title">Layer control</span>
        </template>
        <div class="layer-control">
          <div class="layer-control-container">
            <div class="layer-control__header">
              <div class="v-spacer"></div>
              <div class="layer-item__button" @click="addNewGroup">
                <SvgIcon size="14" type="mdi" :path="path.group.create" />
              </div>
              <div class="layer-item__button" @click="onRemoveAllLayer">
                <SvgIcon size="14" type="mdi" :path="path.deleteAll" />
              </div>
            </div>
            <div class="layer-control__list">
              <draggable-group-list
                ref="layerGroup"
                :items.sync="layers"
                :groupShow.sync="groupShow"
                :selected.sync="itemsLayerSelectId"
                :disabled="disabled"
                :disabledDrag="disabledDrag"
                @click-drag:done="updateLayers()"
                @click-group:remove="$emit('click:remove-group', $event)"
                @click-group:toggle-show="onToggleShowGroup"
              >
                <template #item="{ isSelected, item, toggleSelect }">
                  <slot
                    name="item"
                    :item="item"
                    :isSelected="isSelected"
                    :toggleSelect="toggleSelect"
                  >
                    <component
                      :is="item.component"
                      :item="item"
                      :isSelected="isSelected"
                      @update:item="onUpdateLayer"
                      @click:bounds="onToBounds"
                      @click:remove="onRemoveLayer"
                      @click:action="onLayerAction"
                      @click="toggleSelect(item)"
                    >
                      <template #extra-btn="{ loading }">
                        <div
                          v-if="item.menus && item.menus.length > 0"
                          class="layer-item__button"
                          :disabled="loading"
                          @click.prevent.stop="handleContextClick($event, item)"
                        >
                          <SvgIcon size="14" type="mdi" :path="path.menu" />
                        </div>
                      </template>
                    </component>
                  </slot>
                </template>
              </draggable-group-list>
            </div>
          </div>
        </div>
      </DraggableSidebar>
    </template>
    <slot />
    <LayerItemContextMenu
      ref="vueSimpleContextMenu"
      :options="menu_context.items"
      @click:option="onLayerAction"
    />
  </ModuleContainer>
</template>

<script>
import LayerItemContextMenu from "./layer-item-context-menu.vue";
import LayerItem from "./item/layer-item.vue";
import LayerItemCompare from "./item/layer-item-compare.vue";
import DraggableGroupList from "@/components/DraggableList/draggable-group-list";
import { DraggableSidebar } from "@hungpv97/vue-library-draggable";
import { mdiDelete, mdiDotsVertical, mdiGroup, mdiLayers } from "@mdi/js";

import { ModuleMixin, MapControlButton } from "@hungpv97/vue-library-map/mixin";
import { eventBus, EVENTBUS_TYPE } from "@hungpv97/vue-library-map/event-bus";
import { storeDatasource } from "@hungpv97/vue-library-map/store";
const { createLayer, getLayerData, removeLayer, setLayersView, layersView } =
  storeDatasource;
import {
  toggleShow,
  updateLayerSimple
} from "@hungpv97/vue-library-map/helper";
export default {
  components: {
    MapControlButton,
    DraggableSidebar,
    DraggableGroupList,
    LayerItem,
    LayerItemCompare,
    LayerItemContextMenu
  },
  mixins: [ModuleMixin],
  props: { disabledDrag: Boolean, disabled: Boolean },
  data: () => ({
    menu_context: {
      items: [],
      layer: null
    },
    show: true,
    itemsLayerSelectId: [],
    groupShow: {},
    layers: []
  }),
  computed: {
    path() {
      return {
        icon: mdiLayers,
        menu: mdiDotsVertical,
        group: { create: mdiGroup },
        deleteAll: mdiDelete
      };
    }
  },
  watch: {},
  beforeDestroy() {},
  methods: {
    onInit() {
      let vm = this;
      vm.layers = layersView(vm.c_mapId);
      vm.addLayerToList = () => {
        if (!vm.c_mapId) return;
        vm.updateLayersFromStore();
      };
      eventBus.on(EVENTBUS_TYPE.MAP.SET_LAYER, vm.addLayerToList);
      eventBus.on(EVENTBUS_TYPE.MAP.UPDATE_LAYERS, (map_id) => {
        if (map_id === vm.c_mapId) {
          vm.updateLayersFromStore();
        }
      });
      vm.removeLayerFromList = (layer_view) => {
        if (!layer_view) return;
        vm.updateLayersFromStore();
      };
      eventBus.on(EVENTBUS_TYPE.MAP.REMOVE_LAYER, vm.removeLayerFromList);
    },
    updateLayersFromStore() {
      this.layers = layersView(this.c_mapId);
      this.updateTree();
    },
    onDestroy() {
      this.onRemoveAllLayer();
      if (this.addLayerToList) {
        eventBus.off(EVENTBUS_TYPE.MAP.SET_LAYER, this.addLayerToList);
      }
      if (this.removeLayerFromList) {
        eventBus.off(EVENTBUS_TYPE.MAP.REMOVE_LAYER, this.removeLayerFromList);
      }
    },
    updateTree() {
      this.$nextTick(() => {
        if (this.$refs.layerGroup) this.$refs.layerGroup.update(this.layers);
      });
    },
    handleContextClick(event, item) {
      this.menu_context.items = item.menus || [];
      this.menu_context.layer = item;
      this.$refs.vueSimpleContextMenu.show(event, item);
    },
    closeContextMenu() {
      this.$refs.vueSimpleContextMenu.close();
      this.menu_context.items = [];
      this.menu_context.layer = null;
    },
    toggleShow() {
      this.show = !this.show;
    },
    updateLayers() {
      let beforeId;
      this.layers
        .slice()
        .reverse()
        .forEach((layer) => {
          getLayerData(layer, (map, temp) => {
            temp.moveLayer(map, beforeId);
            beforeId = temp.getBeforeId();
          });
        });
      setLayersView(this.c_mapId, this.layers);
    },
    addLayer(info) {
      createLayer(this.c_mapId, info);
      this.updateTree();
    },
    onUpdateLayer(layer) {
      updateLayerSimple(layer);
    },
    onToBounds(layer) {
      getLayerData(layer, (map, temp) => {
        let bounds =
          layer.metadata && layer.metadata.bounds
            ? layer.metadata.bounds
            : null;
        temp.flyTo(map, bounds);
      });
    },
    onRemoveLayer(layer) {
      this.removeLayer(layer);
      let index = this.layers.findIndex((x) => x.id == layer.id);
      if (index < 0) {
        return;
      }
      this.layers.splice(index, 1);
    },
    removeLayer(layer) {
      if (
        this.menu_context &&
        this.menu_context.layer &&
        this.menu_context.layer.id === layer.id
      ) {
        this.closeContextMenu();
      }
      removeLayer(this.c_mapId, layer);
    },
    onRemoveAllLayer() {
      if (this.layers) {
        this.layers.forEach((layer) => {
          if (!layer.disable_delete) removeLayer(this.c_mapId, layer);
        });
      }
      this.layers = [];
    },
    onLayerAction({ menu, item }) {
      if (menu && menu.click) {
        this.callMap((map) => {
          menu.click(item, map, menu);
        });
      }
    },
    addNewGroup() {
      this.$refs.layerGroup.addNewGroup("");
    },
    onToggleShowGroup(group) {
      let show = group.show;
      let children = group.children || [];
      children.forEach((child) => {
        child.show = show;
        toggleShow(child, show);
      });
    }
  }
};
</script>
<style>
.fill-height {
  height: 100%;
}
</style>
<style scoped>
.layer-control-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  width: 100%;
}
.layer-control__list {
  flex-grow: 1;
  overflow: auto;
  padding: 4px 12px 8px;
}
.layer-control {
  height: 100%;
  overflow: hidden;
}
.layer-control__title {
  flex-grow: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.draggable-group__divider {
  padding: 4px 0;
  display: block;
  flex: 1 1 100%;
  height: 0px;
  max-height: 0px;
  opacity: 0.12;
  transition: inherit;
  border-style: solid;
  border-width: thin 0 0 0;
}
.layer-control__header {
  display: flex;
  align-items: center;
  padding: 8px;
}
.v-spacer {
  flex: 1 1 auto;
}
.layer-control__header .layer-item__button {
  display: inline-block;
  margin-left: 8px;
  cursor: pointer;
}
</style>
